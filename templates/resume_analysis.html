{% extends "base.html" %}

{% block title %}Resume Analysis - Student Performance Predictor{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
        min-height: 100vh;
    }

    .hero-section {
        background: linear-gradient(135deg, #1a75ff 0%, #003399 100%);
        color: white;
        padding: 4rem 2rem;
        text-align: center;
        margin-bottom: 3rem;
        border-radius: 0 0 2rem 2rem;
    }

    .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .hero-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .upload-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
    }

    .drop-zone {
        border: 2px dashed #3f51b5;
        border-radius: 10px;
        padding: 3rem;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(63, 81, 181, 0.05);
        cursor: pointer;
        margin-bottom: 1.5rem;
    }

    .drop-zone.dragover {
        background: rgba(63, 81, 181, 0.1);
        border-color: #1a237e;
    }

    .drop-zone i {
        font-size: 3rem;
        color: #3f51b5;
        margin-bottom: 1rem;
    }

    .results-container {
        display: none;
        margin-top: 2rem;
    }

    .score-circle {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        position: relative;
    }

    .skill-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .skill-matched {
        background: #c8e6c9;
        color: #2e7d32;
    }

    .skill-unmatched {
        background: #ffcdd2;
        color: #c62828;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3f51b5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .btn-analyze {
        background: linear-gradient(135deg, #1a75ff, #003399);
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        width: 100%;
        max-width: 300px;
        margin: 1rem auto;
        display: none;
        transition: all 0.3s ease;
    }

    .btn-analyze:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 50, 153, 0.3);
    }

    .btn-analyze i {
        margin-right: 0.5rem;
    }

    .selected-file {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background: #e3f2fd;
        border-radius: 4px;
        display: none;
    }

    .selected-file i {
        color: #1565c0;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1 class="hero-title">Resume Analysis</h1>
        <p class="hero-subtitle">Upload your resume to get detailed insights and recommendations</p>
    </div>
</div>

<div class="loading-overlay">
    <div class="spinner"></div>
    <p class="mt-3">Analyzing your resume...</p>
</div>

<div class="container upload-container">
    <h2 class="text-center mb-4">Resume Analysis</h2>
    <div class="drop-zone" id="dropZone">
        <i class="fas fa-cloud-upload-alt"></i>
        <h4>Drag & Drop your resume here</h4>
        <p>or click to select a file</p>
        <p class="text-muted">Supported formats: PDF, DOC, DOCX (Max 5MB)</p>
        <input type="file" id="fileInput" accept=".pdf,.doc,.docx" style="display: none;">
    </div>
    
    <div class="selected-file" id="selectedFile">
        <i class="fas fa-file-alt"></i>
        <span id="fileName"></span>
    </div>

    <div class="text-center">
        <button class="btn btn-analyze" id="analyzeBtn">
            <i class="fas fa-search"></i>Analyze Resume
        </button>
    </div>

    <div class="results-container" id="resultsContainer">
        <div class="card mb-4">
            <div class="card-body text-center">
                <h3>ATS Score</h3>
                <div class="score-circle" id="scoreGauge"></div>
                <h4 id="atsVerdict" class="mt-3"></h4>
                <p id="atsSummary" class="text-muted"></p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h4>Technical Skills</h4>
                        <div id="technicalSkills"></div>
                        <p class="mt-2">Skills Match: <span id="skillsMatchPercentage"></span>%</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h4>Soft Skills</h4>
                        <div id="softSkills"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h4>Education & Experience</h4>
                <div id="education"></div>
                <hr>
                <div id="experience"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h4>Recommendations to Improve</h4>
                <ul id="recommendations" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/gauge-chart@0.5.3/dist/bundle.js"></script>
<script>
    let selectedFile = null;

    function debugLog(message, data = null) {
        console.log(`[Debug] ${message}`, data || '');
    }

    function validateFile(file) {
        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        if (!allowedTypes.includes(file.type)) {
            throw new Error('Invalid file type. Please upload a PDF, DOC, or DOCX file.');
        }

        if (file.size > maxSize) {
            throw new Error('File size exceeds 5MB limit.');
        }

        return true;
    }

    function showSelectedFile(file) {
        const fileNameElement = document.getElementById('fileName');
        const selectedFileElement = document.getElementById('selectedFile');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        fileNameElement.textContent = file.name;
        selectedFileElement.style.display = 'block';
        analyzeBtn.style.display = 'block';
    }

    function handleFileSelect(file) {
        try {
            if (validateFile(file)) {
                selectedFile = file;
                showSelectedFile(file);
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Invalid File',
                text: error.message,
                confirmButtonColor: '#1a75ff'
            });
        }
    }

    document.getElementById('dropZone').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFileSelect(file);
        }
    });

    document.getElementById('analyzeBtn').addEventListener('click', async () => {
        if (!selectedFile) {
            Swal.fire({
                icon: 'error',
                title: 'No File Selected',
                text: 'Please select a resume file to analyze.',
                confirmButtonColor: '#1a75ff'
            });
            return;
        }

        const formData = new FormData();
        formData.append('resume', selectedFile);

        document.querySelector('.loading-overlay').style.display = 'flex';

        try {
            const response = await fetch('/analyze_resume', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                displayResults(result);
            } else {
                throw new Error(result.error || 'Failed to analyze resume');
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Analysis Failed',
                text: error.message || 'An error occurred while analyzing the resume',
                confirmButtonColor: '#1a75ff'
            });
        } finally {
            document.querySelector('.loading-overlay').style.display = 'none';
        }
    });

    // Add drag and drop support
    const dropZone = document.getElementById('dropZone');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        
        const file = e.dataTransfer.files[0];
        if (file) {
            handleFileSelect(file);
        }
    });

    let gaugeInstance = null;

    function initGauge(element) {
        const gaugeOptions = {
            arcWidth: 0.2,
            maxValue: 100,
            animationSpeed: 1
        };
        return GaugeChart.gaugeChart(element, gaugeOptions);
    }

    function updateGauge(score) {
        if (!gaugeInstance) {
            gaugeInstance = initGauge(document.getElementById('scoreGauge'));
        }
        gaugeInstance.updateValue(score / 100);
    }

    function displayResults(data) {
        debugLog('Displaying results', data);

        // Update ATS score and verdict
        updateGauge(data.ats_score);
        document.getElementById('atsVerdict').textContent = data.ats_verdict;
        document.getElementById('atsSummary').textContent = data.ats_summary;

        // Update technical skills
        const technicalSkillsDiv = document.getElementById('technicalSkills');
        technicalSkillsDiv.innerHTML = data.technical_skills.map(skill => 
            `<span class="skill-badge ${skill.matched ? 'skill-matched' : 'skill-unmatched'}">
                ${skill.name}
            </span>`
        ).join('');
        document.getElementById('skillsMatchPercentage').textContent = data.skills_match_percentage;

        // Update soft skills
        const softSkillsDiv = document.getElementById('softSkills');
        softSkillsDiv.innerHTML = data.soft_skills.map(skill => 
            `<span class="skill-badge skill-matched">${skill}</span>`
        ).join('');

        // Update education
        const educationDiv = document.getElementById('education');
        educationDiv.innerHTML = data.education.map(edu => 
            `<div class="mb-2">
                <strong>${edu.degree}</strong><br>
                ${edu.institution} (${edu.year})
            </div>`
        ).join('');

        // Update experience
        const experienceDiv = document.getElementById('experience');
        experienceDiv.innerHTML = data.experience.map(exp => 
            `<div class="mb-2">
                <strong>${exp.position}</strong><br>
                ${exp.company} (${exp.duration})
            </div>`
        ).join('');

        // Update recommendations
        const recommendationsList = document.getElementById('recommendations');
        recommendationsList.innerHTML = data.recommendations.map(rec => 
            `<li class="list-group-item">${rec}</li>`
        ).join('');

        resultsContainer.style.display = 'block';
        resultsContainer.scrollIntoView({ behavior: 'smooth' });
    }
</script>
{% endblock %} 