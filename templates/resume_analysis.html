{% extends "base.html" %}

{% block title %}Resume Analysis - Student Performance Predictor{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
        min-height: 100vh;
    }

    .hero-section {
        background: linear-gradient(135deg, #1a75ff 0%, #003399 100%);
        color: white;
        padding: 4rem 2rem;
        text-align: center;
        margin-bottom: 3rem;
        border-radius: 0 0 2rem 2rem;
    }

    .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .hero-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .upload-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
    }

    .drop-zone {
        border: 2px dashed #3f51b5;
        border-radius: 10px;
        padding: 3rem;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(63, 81, 181, 0.05);
        cursor: pointer;
    }

    .drop-zone.dragover {
        background: rgba(63, 81, 181, 0.1);
        border-color: #1a237e;
    }

    .drop-zone i {
        font-size: 3rem;
        color: #3f51b5;
        margin-bottom: 1rem;
    }

    .results-container {
        display: none;
        margin-top: 2rem;
    }

    .score-circle {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        position: relative;
    }

    .skill-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .skill-matched {
        background: #c8e6c9;
        color: #2e7d32;
    }

    .skill-unmatched {
        background: #ffcdd2;
        color: #c62828;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3f51b5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1 class="hero-title">Resume Analysis</h1>
        <p class="hero-subtitle">Upload your resume to get detailed insights and recommendations</p>
    </div>
</div>

<div class="loading-overlay">
    <div class="spinner"></div>
    <p class="mt-3">Analyzing your resume...</p>
</div>

<div class="container upload-container">
    <h2 class="text-center mb-4">Resume Analysis</h2>
    <div class="drop-zone" id="dropZone">
        <i class="fas fa-cloud-upload-alt"></i>
        <h4>Drag & Drop your resume here</h4>
        <p>or click to select a file</p>
        <p class="text-muted">Supported formats: PDF, DOC, DOCX (Max 5MB)</p>
        <input type="file" id="fileInput" accept=".pdf,.doc,.docx" style="display: none;">
    </div>

    <div class="results-container" id="resultsContainer">
        <div class="card mb-4">
            <div class="card-body text-center">
                <h3>ATS Score</h3>
                <div class="score-circle" id="scoreGauge"></div>
                <h4 id="atsVerdict" class="mt-3"></h4>
                <p id="atsSummary" class="text-muted"></p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h4>Technical Skills</h4>
                        <div id="technicalSkills"></div>
                        <p class="mt-2">Skills Match: <span id="skillsMatchPercentage"></span>%</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-body">
                        <h4>Soft Skills</h4>
                        <div id="softSkills"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h4>Education & Experience</h4>
                <div id="education"></div>
                <hr>
                <div id="experience"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h4>Recommendations to Improve</h4>
                <ul id="recommendations" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/gauge-chart@0.5.3/dist/bundle.js"></script>
<script>
    function debugLog(message, data = null) {
        console.log(`[Debug] ${message}`, data || '');
    }

    function validateFile(file) {
        const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        const maxSize = 5 * 1024 * 1024; // 5MB

        if (!allowedTypes.includes(file.type)) {
            alert('Please upload a PDF, DOC, or DOCX file.');
            return false;
        }

        if (file.size > maxSize) {
            alert('File size must be less than 5MB.');
            return false;
        }

        return true;
    }

    let gaugeInstance = null;

    function initGauge(element) {
        const gaugeOptions = {
            arcWidth: 0.2,
            maxValue: 100,
            animationSpeed: 1
        };
        return GaugeChart.gaugeChart(element, gaugeOptions);
    }

    function updateGauge(score) {
        if (!gaugeInstance) {
            gaugeInstance = initGauge(document.getElementById('scoreGauge'));
        }
        gaugeInstance.updateValue(score / 100);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const loadingOverlay = document.querySelector('.loading-overlay');
        const resultsContainer = document.getElementById('resultsContainer');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('dragover');
            });
        });

        dropZone.addEventListener('drop', handleDrop);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            handleFile(file);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            handleFile(file);
        }

        function handleFile(file) {
            if (!validateFile(file)) return;

            const formData = new FormData();
            formData.append('resume', file);

            loadingOverlay.style.display = 'flex';
            resultsContainer.style.display = 'none';

            fetch('/analyze_resume', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data);
                } else {
                    alert(data.error || 'An error occurred while analyzing the resume.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while analyzing the resume.');
            })
            .finally(() => {
                loadingOverlay.style.display = 'none';
            });
        }

        function displayResults(data) {
            debugLog('Displaying results', data);

            // Update ATS score and verdict
            updateGauge(data.ats_score);
            document.getElementById('atsVerdict').textContent = data.ats_verdict;
            document.getElementById('atsSummary').textContent = data.ats_summary;

            // Update technical skills
            const technicalSkillsDiv = document.getElementById('technicalSkills');
            technicalSkillsDiv.innerHTML = data.technical_skills.map(skill => 
                `<span class="skill-badge ${skill.matched ? 'skill-matched' : 'skill-unmatched'}">
                    ${skill.name}
                </span>`
            ).join('');
            document.getElementById('skillsMatchPercentage').textContent = data.skills_match_percentage;

            // Update soft skills
            const softSkillsDiv = document.getElementById('softSkills');
            softSkillsDiv.innerHTML = data.soft_skills.map(skill => 
                `<span class="skill-badge skill-matched">${skill}</span>`
            ).join('');

            // Update education
            const educationDiv = document.getElementById('education');
            educationDiv.innerHTML = data.education.map(edu => 
                `<div class="mb-2">
                    <strong>${edu.degree}</strong><br>
                    ${edu.institution} (${edu.year})
                </div>`
            ).join('');

            // Update experience
            const experienceDiv = document.getElementById('experience');
            experienceDiv.innerHTML = data.experience.map(exp => 
                `<div class="mb-2">
                    <strong>${exp.position}</strong><br>
                    ${exp.company} (${exp.duration})
                </div>`
            ).join('');

            // Update recommendations
            const recommendationsList = document.getElementById('recommendations');
            recommendationsList.innerHTML = data.recommendations.map(rec => 
                `<li class="list-group-item">${rec}</li>`
            ).join('');

            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }
    });
</script>
{% endblock %} 